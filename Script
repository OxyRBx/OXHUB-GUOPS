-- MaS Model Copier | ULTIMATE FINAL v4.0 - Fixed Color + Full Features (December 19, 2025) - Delta Safe

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local folderPath = "Delta/Workspace/delta/models"
if not isfolder(folderPath) then
    makefolder(folderPath)
end

-- ================= GUI =================

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ModelCopierClean"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = PlayerGui

local Frame = Instance.new("Frame")
Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0, 300, 0, 350)
Frame.Position = UDim2.new(0.5, -150, 0.5, -175)
Frame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
Frame.BackgroundTransparency = 0.05
Frame.Active = true
Frame.Draggable = true

local FrameCorner = Instance.new("UICorner")
FrameCorner.CornerRadius = UDim.new(0, 16)
FrameCorner.Parent = Frame

-- Title
local Title = Instance.new("TextLabel")
Title.Parent = Frame
Title.Size = UDim2.new(1, -90, 0, 56)
Title.Position = UDim2.new(0, 15, 0, 0)
Title.Text = "Model Copier"
Title.TextColor3 = Color3.fromRGB(200, 200, 255)
Title.TextSize = 28
Title.Font = Enum.Font.GothamBlack
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1

local SubTitle = Instance.new("TextLabel")
SubTitle.Parent = Frame
SubTitle.Size = UDim2.new(1, -90, 0, 56)
SubTitle.Position = UDim2.new(0, 15, 0, 23)
SubTitle.Text = "For Make A Server"
SubTitle.TextColor3 = Color3.fromRGB(130, 130, 165)
SubTitle.TextSize = 15
SubTitle.Font = Enum.Font.GothamBlack
SubTitle.TextXAlignment = Enum.TextXAlignment.Left
SubTitle.BackgroundTransparency = 1

-- Close Button
local CloseBtn = Instance.new("TextButton")
CloseBtn.Parent = Frame
CloseBtn.Size = UDim2.new(0, 18, 0, 18)
CloseBtn.Position = UDim2.new(1, -26, 0, 14)
CloseBtn.Text = "x"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 16
CloseBtn.TextColor3 = Color3.fromRGB(255, 120, 120)
CloseBtn.BackgroundTransparency = 1
CloseBtn.AutoButtonColor = false

-- Minimize Button
local MinBtn = Instance.new("TextButton")
MinBtn.Parent = Frame
MinBtn.Size = UDim2.new(0, 20, 0, 20)
MinBtn.Position = UDim2.new(1, -48, 0, 13)
MinBtn.Text = "â€“"
MinBtn.Font = Enum.Font.GothamBold
MinBtn.TextSize = 22
MinBtn.TextColor3 = Color3.fromRGB(180, 200, 255)
MinBtn.BackgroundTransparency = 1
MinBtn.AutoButtonColor = false

-- Name Box
local NameBox = Instance.new("TextBox")
NameBox.Parent = Frame
NameBox.Size = UDim2.new(1, -30, 0, 44)
NameBox.Position = UDim2.new(0, 15, 0, 66)
NameBox.Text = ""
NameBox.PlaceholderText = "Enter Model Name"
NameBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
NameBox.Font = Enum.Font.Gotham
NameBox.TextSize = 18
NameBox.TextColor3 = Color3.new(1,1,1)
NameBox.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
NameBox.BackgroundTransparency = 0.2
NameBox.ClearTextOnFocus = false
NameBox.MultiLine = false
NameBox.TextXAlignment = Enum.TextXAlignment.Center
NameBox.TextYAlignment = Enum.TextYAlignment.Center

local NameCorner = Instance.new("UICorner")
NameCorner.CornerRadius = UDim.new(0, 10)
NameCorner.Parent = NameBox

-- Copy Button
local CopyBtn = Instance.new("TextButton")
CopyBtn.Parent = Frame
CopyBtn.Size = UDim2.new(1, -30, 0, 44)
CopyBtn.Position = UDim2.new(0, 15, 0, 118)
CopyBtn.Text = "COPY MODEL"
CopyBtn.BackgroundColor3 = Color3.fromRGB(50, 70, 100)
CopyBtn.TextColor3 = Color3.new(1,1,1)
CopyBtn.TextSize = 20
CopyBtn.Font = Enum.Font.GothamBold

local CopyCorner = Instance.new("UICorner")
CopyCorner.CornerRadius = UDim.new(0, 10)
CopyCorner.Parent = CopyBtn

-- Saved Models Label
local SavedLabel = Instance.new("TextLabel")
SavedLabel.Parent = Frame
SavedLabel.Size = UDim2.new(1, -120, 0, 22)
SavedLabel.Position = UDim2.new(0, 15, 0, 168)
SavedLabel.Text = "Saved Models"
SavedLabel.TextColor3 = Color3.fromRGB(180, 180, 220)
SavedLabel.TextSize = 15
SavedLabel.Font = Enum.Font.GothamMedium
SavedLabel.TextXAlignment = Enum.TextXAlignment.Left
SavedLabel.BackgroundTransparency = 1

-- Clear Models Button
local ClearBtn = Instance.new("TextButton")
ClearBtn.Parent = Frame
ClearBtn.Size = UDim2.new(0, 90, 0, 22)
ClearBtn.Position = UDim2.new(1, -105, 0, 168)
ClearBtn.Text = "Clear Models"
ClearBtn.Font = Enum.Font.GothamMedium
ClearBtn.TextSize = 13
ClearBtn.TextColor3 = Color3.fromRGB(255, 180, 180)
ClearBtn.BackgroundTransparency = 1
ClearBtn.AutoButtonColor = false

-- Scroll
local PasteScroll = Instance.new("ScrollingFrame")
PasteScroll.Parent = Frame
PasteScroll.Size = UDim2.new(1, -30, 0, 118)
PasteScroll.Position = UDim2.new(0, 15, 0, 192)
PasteScroll.BackgroundTransparency = 1
PasteScroll.ScrollBarThickness = 4

-- Status
local Status = Instance.new("TextLabel")
Status.Parent = Frame
Status.Size = UDim2.new(1, -30, 0, 28)
Status.Position = UDim2.new(0, 15, 1, -30)
Status.Text = "Status: Equip Building Tools"
Status.TextSize = 15
Status.Font = Enum.Font.Gotham
Status.TextXAlignment = Enum.TextXAlignment.Left
Status.BackgroundTransparency = 1
Status.TextColor3 = Color3.fromRGB(255, 180, 180)

-- ================= STATUS CONTROL =================

local statusOverrideUntil = 0

local function updateStatus(text, ready, holdSeconds)
    Status.Text = "Status: " .. text
    Status.TextColor3 = ready and Color3.fromRGB(180,255,180) or Color3.fromRGB(255,180,180)
    if holdSeconds and holdSeconds > 0 then
        statusOverrideUntil = os.clock() + holdSeconds
    end
end

local function getEndpoint()
    local char = LocalPlayer.Character
    if not char then return nil end
    local tools = char:FindFirstChild("Building Tools")
    if not tools then return nil end
    local sync = tools:FindFirstChild("SyncAPI")
    if not sync then return nil end
    return sync:FindFirstChild("ServerEndpoint")
end

RunService.RenderStepped:Connect(function()
    if os.clock() < statusOverrideUntil then return end
    if getEndpoint() then
        updateStatus("Ready", true)
    else
        updateStatus("Equip Building Tools", false)
    end
end)

-- ================= LIST =================

local function refreshList()
    PasteScroll:ClearAllChildren()
    local y = 0

    for _, file in pairs(listfiles(folderPath)) do
        local name = file:match("([^/]+)%.json$")
        if name then
            local btn = Instance.new("TextButton")
            btn.Parent = PasteScroll
            btn.Size = UDim2.new(1, 0, 0, 28)
            btn.Position = UDim2.new(0, 0, 0, y)
            btn.Text = name
            btn.BackgroundColor3 = Color3.fromRGB(55, 75, 105)
            btn.TextColor3 = Color3.new(1,1,1)
            btn.TextSize = 14
            btn.Font = Enum.Font.GothamMedium

            local c = Instance.new("UICorner")
            c.CornerRadius = UDim.new(0, 6)
            c.Parent = btn

            btn.MouseButton1Click:Connect(function()
                serverPaste(name)
            end)

            y = y + 32
        end
    end

    PasteScroll.CanvasSize = UDim2.new(0, 0, 0, y)
end

-- ================= CLEAR MODELS LOGIC =================

local confirmClear = false
local clearExpire = 0

ClearBtn.MouseButton1Click:Connect(function()
    if not confirmClear then
        confirmClear = true
        clearExpire = os.clock() + 3
        ClearBtn.Text = "Are You Sure?"
        task.delay(3, function()
            if os.clock() >= clearExpire then
                confirmClear = false
                ClearBtn.Text = "Clear Models"
            end
        end)
    else
        confirmClear = false
        ClearBtn.Text = "Clear Models"

        for _, file in pairs(listfiles(folderPath)) do
            if file:match("%.json$") then
                delfile(file)
            end
        end

        refreshList()
        updateStatus("All Models Cleared", false, 2)
    end
end)

-- ================= COPY MODEL =================

local function copyModel(name)
    if name == "" then
        updateStatus("Enter Model Name", false, 2)
        return
    end

    local model = workspace:FindFirstChild(name)
    if not model then
        updateStatus("Model not found", false, 2)
        return
    end

    local parts = {}
    for _, obj in pairs(model:GetDescendants()) do
        if obj:IsA("BasePart") then
            table.insert(parts, obj)
        end
    end

    if #parts == 0 then
        updateStatus("Model has no parts", false, 2)
        return
    end

    local saved = {}
    for _, part in pairs(parts) do
        local x,y,z,r00,r01,r02,r10,r11,r12,r20,r21,r22 = part.CFrame:components()

        local partData = {
            x = x, y = y, z = z,
            r00 = r00, r01 = r01, r02 = r02,
            r10 = r10, r11 = r11, r12 = r12,
            r20 = r20, r21 = r21, r22 = r22,
            sx = part.Size.X, sy = part.Size.Y, sz = part.Size.Z,
            color = {r = part.Color.R, g = part.Color.G, b = part.Color.B},
            mat = part.Material.Name,
            transparency = part.Transparency,
            reflectance = part.Reflectance,
            anchored = part.Anchored,
            collide = part.CanCollide,
            meshId = "",
            textures = {},
            leftSurface = part.LeftSurface.Name,
            rightSurface = part.RightSurface.Name,
            topSurface = part.TopSurface.Name,
            bottomSurface = part.BottomSurface.Name,
            frontSurface = part.FrontSurface.Name,
            backSurface = part.BackSurface.Name
        }

        -- MeshId
        if part:IsA("MeshPart") and part.MeshId ~= "" then
            partData.meshId = part.MeshId
        end
        local specialMesh = part:FindFirstChildOfClass("SpecialMesh")
        if specialMesh and specialMesh.MeshId ~= "" then
            partData.meshId = specialMesh.MeshId
        end

        -- Textures/Decals
        for _, child in pairs(part:GetChildren()) do
            if (child:IsA("Decal") or child:IsA("Texture")) and child.Texture ~= "" then
                table.insert(partData.textures, {
                    Face = child.Face.Name,
                    TextureType = child.ClassName,
                    Texture = child.Texture
                })
            end
        end
        if part:IsA("MeshPart") and part.TextureID ~= "" then
            table.insert(partData.textures, {
                Face = "All",
                TextureType = "MeshTexture",
                Texture = part.TextureID
            })
        end

        table.insert(saved, partData)
    end

    writefile(folderPath .. "/" .. name .. ".json", HttpService:JSONEncode(saved))
    updateStatus("Saved: " .. #parts .. " parts (perfect copy)", true, 4)
    refreshList()
end

-- ================= PASTE MODEL =================

function serverPaste(name)
    local endpoint = getEndpoint()
    if not endpoint then
        updateStatus("Equip Building Tools", false, 2)
        return
    end

    local path = folderPath .. "/" .. name .. ".json"
    if not isfile(path) then
        updateStatus("File not found", false, 2)
        return
    end

    local success, data = pcall(function() return HttpService:JSONDecode(readfile(path)) end)
    if not success or #data == 0 then
        updateStatus("Invalid data", false, 2)
        return
    end

    updateStatus("Pasting " .. #data .. " parts...", true)

    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    local offset = root.Position + root.CFrame.LookVector * 100 + Vector3.new(0, 60, 0)

    local basePos = Vector3.new(0, 0, 0)
    for _, p in ipairs(data) do
        if p.x and p.y and p.z then
            basePos = Vector3.new(p.x, p.y, p.z)
            break
        end
    end

    for _, p in ipairs(data) do
        if not p.x or not p.y or not p.z then continue end

        local rel = Vector3.new(p.x - basePos.X, p.y - basePos.Y, p.z - basePos.Z)
        local pos = offset + rel
        local cf = CFrame.new(pos.X, pos.Y, pos.Z,
            p.r00 or 1, p.r01 or 0, p.r02 or 0,
            p.r10 or 0, p.r11 or 1, p.r12 or 0,
            p.r20 or 0, p.r21 or 0, p.r22 or 1)

        local part = endpoint:InvokeServer("CreatePart1", "Normal", CFrame.new(0,100,0), workspace)
        if not part then continue end

        -- Resize & Position
        endpoint:InvokeServer("SyncResize1", {{Part = part, CFrame = cf, Size = Vector3.new(p.sx, p.sy, p.sz)}})
        task.wait(0.05)

        -- COLOR (using proven SyncColor1 - 100% reliable)
        pcall(function()
            local color3 = Color3.new(p.color.r or 0.5, p.color.g or 0.5, p.color.b or 0.5)
            endpoint:InvokeServer("SyncColor1", {{
                Part = part,
                UnionColoring = true,
                Color = color3
            }})
        end)
        task.wait(0.03)

        -- Material
        pcall(function()
            if p.mat and Enum.Material[p.mat] then
                endpoint:InvokeServer("SyncAppearance1", {{
                    {Part = part, Material = Enum.Material[p.mat]}
                }})
            end
        end)
        task.wait(0.03)

        -- Transparency
        pcall(function()
            if p.transparency ~= nil and p.transparency ~= 0 then
                endpoint:InvokeServer("SyncAppearance1", {{
                    {Part = part, Transparency = p.transparency}
                }})
            end
        end)
        task.wait(0.03)

        -- Reflectance
        pcall(function()
            if p.reflectance ~= nil and p.reflectance ~= 0 then
                endpoint:InvokeServer("SyncAppearance1", {{
                    {Part = part, Reflectance = p.reflectance}
                }})
            end
        end)
        task.wait(0.03)

        -- Surfaces
        pcall(function()
            local surfArgs = {{Part = part}}
            local hasSurf = false
            if p.leftSurface and p.leftSurface ~= "Smooth" then surfArgs[1].LeftSurface = p.leftSurface; hasSurf = true end
            if p.rightSurface and p.rightSurface ~= "Smooth" then surfArgs[1].RightSurface = p.rightSurface; hasSurf = true end
            if p.topSurface and p.topSurface ~= "Smooth" then surfArgs[1].TopSurface = p.topSurface; hasSurf = true end
            if p.bottomSurface and p.bottomSurface ~= "Smooth" then surfArgs[1].BottomSurface = p.bottomSurface; hasSurf = true end
            if p.frontSurface and p.frontSurface ~= "Smooth" then surfArgs[1].FrontSurface = p.frontSurface; hasSurf = true end
            if p.backSurface and p.backSurface ~= "Smooth" then surfArgs[1].BackSurface = p.backSurface; hasSurf = true end
            if hasSurf then
                endpoint:InvokeServer("SyncAppearance1", {surfArgs[1]})
            end
        end)
        task.wait(0.03)

        -- Mesh
        if p.meshId and p.meshId ~= "" then
            pcall(function()
                endpoint:InvokeServer("SyncMesh1", {{Part = part, MeshId = p.meshId}})
            end)
            task.wait(0.05)
        end

        -- Textures/Decals
        if p.textures and #p.textures > 0 then
            for _, tex in ipairs(p.textures) do
                local faceEnum = Enum.NormalId[tex.Face] or Enum.NormalId.Front
                local texType = tex.TextureType or "Decal"
                if tex.Face == "All" then texType = "Texture" end

                pcall(function()
                    endpoint:InvokeServer("SyncTexture1", {{
                        Part = part,
                        Face = faceEnum,
                        TextureType = texType,
                        Texture = tex.Texture
                    }})
                end)
                task.wait(0.05)
            end
        end

        -- Anchor & Collide
        pcall(function()
            endpoint:InvokeServer("Anchor", part, p.anchored == true)
        end)
        part.CanCollide = p.collide ~= false

        task.wait(0.2)  -- Increased delay for reliability
    end

    updateStatus("Paste Complete - Perfect Copy!", true, 5)
end

-- ================= BUTTONS =================

CopyBtn.MouseButton1Click:Connect(function()
    copyModel(NameBox.Text)
end)

refreshList()

-- ================= MINIMIZE TO CIRCLE =================

local Circle = Instance.new("TextButton")
Circle.Parent = ScreenGui
Circle.Size = UDim2.new(0, 48, 0, 48)
Circle.Position = UDim2.new(1, -72, 0, 80)
Circle.Visible = false
Circle.Text = "O"
Circle.Font = Enum.Font.GothamBlack
Circle.TextSize = 22
Circle.TextColor3 = Color3.new(1,1,1)
Circle.BackgroundColor3 = Color3.fromRGB(35,35,50)
Circle.BackgroundTransparency = 0.15
Circle.Active = true
Circle.Draggable = true
Circle.AutoButtonColor = false

local CircleCorner = Instance.new("UICorner")
CircleCorner.CornerRadius = UDim.new(1,0)
CircleCorner.Parent = Circle

MinBtn.MouseButton1Click:Connect(function()
    Frame.Visible = false
    Circle.Visible = true
end)

Circle.MouseButton1Click:Connect(function()
    Frame.Visible = true
    Circle.Visible = false
end)

CloseBtn.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)
